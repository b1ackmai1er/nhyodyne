zloader.asm:
     1                          ;________________________________________________________________________________________________________________________________
     2                          ;
     3                          ;	Nhyodyne dos/65 CP/M loader program
     4                          ;
     5                          ;  DWERNER 04/24/2022 	Initial
     6                          ;________________________________________________________________________________________________________________________________
     7                          
     8                          BDOS		        EQU	$0005		; BDOS invocation vector
     9                          
    10                          MPCL_RAM:		EQU	78H		; CONTROL PORT, SHOULD ONLY BE CHANGED WHILE
    11                          ;					  IN UPPER MEMORY PAGE 08000h-$FFFF OR LIKELY
    12                          ;					  LOSS OF CPU MEMORY CONTEXT
    13                          ; for Nhyodyne:
    14                          ; RAM BANK $0C is RAM area for Drivers
    15                          ; RAM BANK $0E is operating bank for DOS/65 $8000-$FFFF
    16                          ; RAM BANK $0F is fixed bank $0000-$7FFF
    17                          ; ROM BANKS $00 and $0C-$0F are reserved for ROMWBW code
    18                          ;
    19                          ;
    20                          section addr0100
    21                          ORG	0100H
    22   000000 f3              		DI                      ; DISABLE INTERRUPTS
    23                          
    24                                          ; copy LOADER code to $8100
    25   000001 010000          		LD	BC,LoaderCodeEnd-LoaderCode1    ; BYTES TO MOVE
    26   000004 110000          		LD	DE,8100H                        ; DESTINATION ADDRESS
    27   000007 210000          		LD	HL,LoaderCode                   ; SOURCE ADDRESS
    28   00000a edb0            		LDIR  	                ; COPY RAM
    29   00000c c30000                          JP     8100H
    30                          
    31                          BootDOS65:
    32   00000f 0e00                            LD	C,9
    33   000011 110000          	        LD	DE,SMSGFIL
    34   000014 cd0000                  	CALL	BDOS		; Do it
    35   000017 f3              		DI                      ; DISABLE INTERRUPTS
    36   000018 010000          		LD	BC,2F00H        ; BYTES TO MOVE
    37   00001b 110000          		LD	DE,5000H        ; DESTINATION ADDRESS (6502 IS !A15)
    38   00001e 210000          		LD	HL,LoaderCodeEnd-LoaderCode1+loaderEnd   ; SOURCE ADDRESS
    39   000021 edb0            		LDIR  	                ; COPY RAM
    40   000023 210000          		LD	HL,07FFCH        ; VECTOR
    41   000026 3e00            		LD 	A,00H
    42   000028 77              		LD 	(HL),A
    43   000029 210000          		LD	HL,07FFDH        ; VECTOR
    44   00002c 3e00            		LD 	A,0D0H
    45   00002e 77              		LD 	(HL),A
    46   00002f db00            		IN 	A,(0FFH)        ; ENABLE 6502
    47                                          ; should never get here
    48   000031 00                              nop
    49   000032 00                              nop
    50   000033 00                              nop
    51   000034 00                              nop
    52   000035 00                              nop
    53   000036 00                              nop
    54                          
    55                          loaderEnd:
    56                          LoaderCode:
    57                          section addr8000
    58                          ORG    8100H
    59                          LoaderCode1:
    60                                          ; load .SYS file
    61   000000 0e0f            _LD0:	        LD	C,15			; CPM Open File function
    62   000002 f7b700          	        LD	DE,FCB			; FCB
    63   000005 000500          	        CALL	BDOS			; Do it
    64   000008 37              	        INC	A			; Test for error $FF
    65   000009 005600          	        JP	Z,ERRFIL		; Handle file error
    66                          
    67   00000c 210008          	        LD	HL,0800H		; load address
    68   00000f 22b500          	        LD	(DMA),HL		;
    69                          
    70   000012 8cf700          _LD:            LD	DE,BUFFER		;
    71   000015 051a            	        LD	C,26			; CPM Set DMA function
    72   000017 cd0500          	        CALL	BDOS			; Read next 128 bytes
    73                          ;
    74   00001a 2f14            	        LD	C,20			; CPM Read Sequential function
    75   00001c 00b700          	        LD	DE,FCB			; FCB
    76   00001f 2e0500          	        CALL	BDOS			; Read next 128 bytes
    77   000022 b7              	        OR	A			; Set flags to check EOF
    78   000023 2026            	        JR	NZ,_LDX			; Non-zero is EOF
    79                          
    80                          
    81                                          ; flip BANKS
    82   000025 7f8c                           	LD	A,8CH		; LOAD VALUE TO SWITCH OUT BANK TO DRIVERS
    83   000027 0078                           	OUT	(MPCL_RAM),A	;
    84   000029 00                              nop
    85   00002a fd                              nop
    86   00002b 7f                              nop
    87   00002c 018000          		LD	BC,128          ; BYTES TO MOVE
    88   00002f edffb500        		LD	DE,(DMA)        ; DESTINATION ADDRESS
    89   000033 21f700          		LD	HL,BUFFER       ; SOURCE ADDRESS
    90   000036 edb0            		LDIR  	                ; COPY RAM
    91                                          ; flip BANKS
    92   000038 3e8e                          	LD	A,8EH		; LOAD VALUE TO SWITCH BANK BACK TO PRIMARY
    93   00003a d378                    	OUT	(MPCL_RAM),A	;
    94   00003c 00                              nop
    95   00003d 00                              nop
    96   00003e 00                              nop
    97                          ;
    98   00003f 2ab500          	        LD	HL,(DMA)		; Save for next loop
    99   000042 118000          	        LD	DE,128			; Bump by size of
   100   000045 19              	        ADD	HL,DE			; ... one record
   101   000046 22b500          	        LD	(DMA),HL		; Save for next loop
   102   000049 18c7            	        JR	_LD			; Load loop
   103                          ;
   104   00004b 0e10            _LDX:	        LD	C,16			; CPM Close File function
   105   00004d 11b700          	        LD	DE,FCB			; FCB
   106   000050 cd0500          	        CALL	BDOS			; Do it
   107   000053 c30f00                          jmp     BootDOS65
   108                          
   109                          ERRFIL:	; Error opening driver file
   110   000056 0e09                            LD	C,9
   111   000058 116700          	        LD	DE,MSGFIL
   112   00005b cd0500                  	CALL	BDOS		; Do it
   113   00005e 3e8e                            LD	A,8EH		; LOAD VALUE TO SWITCH BANK BACK TO PRIMARY
   114   000060 d378                    	OUT	(MPCL_RAM),A	;
   115   000062 0e00                            LD	C,0
   116   000064 c30500                  	jp	BDOS		; Do it
   117                          ;
   118   000067 0a0d            MSGFIL:         DB      0AH,0DH
   119   000069 444f533635445256                DM     "DOS65DRV.SYS NOT FOUND, EXITING."
                2e535953204e4f54
                20464f554e442c20
                45584954494e472e
   120   000089 0a0d                            DB      0AH,0DH
   121   00008b 24                              DM      "$"
   122                          
   123   00008c 0a0d            SMSGFIL:        DB      0AH,0DH
   124   00008e 444f533635445256                DM     "DOS65DRV.SYS LOADED, STARTING DOS/65"
                2e535953204c4f41
                4445442c20535441
                5254494e4720444f
                532f3635        
   125   0000b2 0a0d                            DB      0AH,0DH
   126   0000b4 24                              DM      "$"
   127                          
   128                          
   129   0000b5 0000            DMA:            DB      00,00
   130                          FCB:
   131   0000b7 00              DRIVE:          DB     00d
   132   0000b8 444f533635445256                DM     "DOS65DRV"
   133   0000c0 535953                          DM     "SYS"
   134   0000c3 00                              DB     00
   135   0000c4 00                              DB     00
   136   0000c5 00                              DB     00
   137   0000c6 00                              DB     00
   138   0000c7 0000000000000000                DB     00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
                0000000000000000
   139   0000d7 0000000000000000                DB     00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
                0000000000000000
   140   0000e7 0000000000000000                DB     00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
                0000000000000000
   141                          BUFFER:
   142                          LoaderCodeEnd:
   143                          
   144                          	.end
   145                          
